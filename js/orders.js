//let itemsTest = {
//    "success": true,
//    "data": {
//        "carts": [
//            {
//                "id": 5,
//                "email": "belle@gmail.com",
//                "cost": 175,
//                "status_label": "Не оплачен",
//                "status": 10,
//                "created_at": "12 авг. 2020 г., 15:56:51",
//                "paid_at": null,
//                "orders": [
//                    {
//                        "id": 13,
//                        "cad_num": "76:23:010101:62059",
//                        "address": "Ярославская область, г.Ярославль, ул.Панина, д.30, кв.35",
//                        "order_items": [
//                            {
//                                "price": 100,
//                                "doc_type_label": "Основные характеристики и зарегистрированные права",
//                                "doc_type": 10,
//                                "result_pdf": null,
//                                "result_zip": null
//                            },
//                            {
//                                "price": 75,
//                                "doc_type_label": "О переходе прав",
//                                "doc_type": 20,
//                                "result_pdf": null,
//                                "result_zip": null
//                            }
//                        ]
//                    }
//                ]
//            },
//            {
//                "id": 4,
//                "email": "belle@gmail.com",
//                "cost": 175,
//                "status_label": "Не оплачен",
//                "status": 10,
//                "created_at": "12 авг. 2020 г., 15:26:22",
//                "paid_at": null,
//                "orders": [
//                    {
//                        "id": 12,
//                        "cad_num": "76:23:010101:62059",
//                        "address": "Ярославская область, г Ярославль, ул Панина, д 30, кв 35",
//                        "order_items": [
//                            {
//                                "price": 100,
//                                "doc_type_label": "Основные характеристики и зарегистрированные права",
//                                "doc_type": 10,
//                                "result_pdf": null,
//                                "result_zip": null
//                            },
//                            {
//                                "price": 75,
//                                "doc_type_label": "О переходе прав",
//                                "doc_type": 20,
//                                "result_pdf": null,
//                                "result_zip": null
//                            }
//                        ]
//                    }
//                ]
//            },
//            {
//                "id": 3,
//                "email": "belle@gmail.com",
//                "cost": 75,
//                "status_label": "Оплачен",
//                "status": 20,
//                "created_at": "12 авг. 2020 г., 14:37:28",
//                "paid_at": "12 авг. 2020 г., 14:45:23",
//                "orders": [
//                    {
//                        "id": 11,
//                        "cad_num": "23:33:0907011:9",
//                        "address": "р-н Туапсинский, тер Небугское сельское поселение, с Агой, тер СТ Машиностроитель, д уч.№198",
//                        "order_items": [
//                            {
//                                "price": 75,
//                                "doc_type_label": "О переходе прав",
//                                "doc_type": 20,
//                                "result_pdf": null,
//                                "result_zip": null
//                            }
//                        ]
//                    }
//                ]
//            },
//            {
//                "id": 2,
//                "email": "belle@gmail.com",
//                "cost": 0,
//                "status_label": "Отменен",
//                "status": 40,
//                "created_at": "12 авг. 2020 г., 14:28:56",
//                "paid_at": null,
//                "orders": []
//            },
//            {
//                "id": 1,
//                "email": "belle@gmail.com",
//                "cost": 550,
//                "status_label": "Не оплачен",
//                "status": 10,
//                "created_at": "6 авг. 2020 г., 16:28:27",
//                "paid_at": null,
//                "orders": [
//                    {
//                        "id": 1,
//                        "cad_num": "76:23:010101:62059",
//                        "address": "",
//                        "order_items": [
//                            {
//                                "price": 100,
//                                "doc_type_label": "Основные характеристики и зарегистрированные права",
//                                "doc_type": 10,
//                                "result_pdf": "/storage/discharge/aa4233e0c163580f87946e36a1b96d62.pdf",
//                                "result_zip": "/storage/discharge/e81cd89e27c57d48e260edeb3d0ba717.zip"
//                            },
//                            {
//                                "price": 75,
//                                "doc_type_label": "О переходе прав",
//                                "doc_type": 20,
//                                "result_pdf": "/storage/discharge/d026c2572c6be98f1813c3d0c005be01.pdf",
//                                "result_zip": "/storage/discharge/9e13d03bfd31005f637b014f24c157ce.zip"
//                            }
//                        ]
//                    },
//                    {
//                        "id": 2,
//                        "cad_num": "76:23:010101:62059",
//                        "address": "",
//                        "order_items": [
//                            {
//                                "price": 100,
//                                "doc_type_label": "Основные характеристики и зарегистрированные права",
//                                "doc_type": 10,
//                                "result_pdf": "/storage/discharge/aadd76da33629a0f12cfa62b7026657b.pdf",
//                                "result_zip": "/storage/discharge/aa2ca5b9bb61b0b217b21fd71e06bf04.zip"
//                            }
//                        ]
//                    },
//                    {
//                        "id": 3,
//                        "cad_num": "76:23:010101:62059",
//                        "address": "",
//                        "order_items": [
//                            {
//                                "price": 100,
//                                "doc_type_label": "Основные характеристики и зарегистрированные права",
//                                "doc_type": 10,
//                                "result_pdf": "/storage/discharge/2c49f4deb8c1dce9cb3d4b1321097c14.pdf",
//                                "result_zip": "/storage/discharge/e844d4e82e745ed599deacbd8523c5f6.zip"
//                            }
//                        ]
//                    },
//                    {
//                        "id": 4,
//                        "cad_num": "76:23:010101:62059",
//                        "address": "",
//                        "order_items": [
//                            {
//                                "price": 100,
//                                "doc_type_label": "Основные характеристики и зарегистрированные права",
//                                "doc_type": 10,
//                                "result_pdf": "/storage/discharge/b4e0df1321139e3fe9d99e1bf7e753a8.pdf",
//                                "result_zip": "/storage/discharge/ba059aa013be55bd8172eef29d26f8ed.zip"
//                            },
//                            {
//                                "price": 75,
//                                "doc_type_label": "О переходе прав",
//                                "doc_type": 20,
//                                "result_pdf": "/storage/discharge/b15b5783718b2c59553ae8c74fe87015.pdf",
//                                "result_zip": "/storage/discharge/ba059aa013be55bd8172eef29d26f8ed.zip"
//                            }
//                        ]
//                    }
//                ]
//            }
//        ],
//        "unpaid_carts_count": "10"
//    }
//};



$(document).ready(() => {
	
	let urlCors = 'https://cors-anywhere.herokuapp.com/',
		urlList = 'https://ros.devpreview.info/api/v1/order/list',
		urlPayment = 'https://ros.devpreview.info/api/v1/order/payment',
		urlCancel = 'https://ros.devpreview.info/api/v1/order/cancel',
		userEmail = null;

	let getUserEmail = () => {
		let email = JSON.parse(localStorage.getItem("email"));
		if (email !== null && email.length !== 0) {
			userEmail = email;
		} else {
			userEmail = null;
		}
	}
	
	let getDataOrders = () => {
		if ( userEmail === null) return;
		showPopupLoader();
		getDataAPI( urlCors + urlList + '?email=' + userEmail , optionsGET )
		.then( ( response ) => {
			if (response.success) {
				analysisResponseFromServer( response.data );
			} else {
				showErrorMessage ('errorUnknown', result.data.message )
			}
		})
		.catch( error => showErrorMessage ('errorUnknown'))
		.finally(() => hidePopupLoader () );
	}
	
	let saveDataLocalStorage = (key, data) => {
		let updateData = new UpdateDataLocalStorage(key, data);
		updateData.saveData();
	}
	

	let orderLoginForm = $('.order-login__form'),
		orderLoginInput = $('.order-login__input'),
		orderLoginButton = $('.order-login__button');
	
	let validate = validateEmail( orderLoginForm );	
	
	orderLoginButton.on('click', function (e) {
		
		let value = orderLoginInput.val().trim();
		validate = validateEmail( orderLoginForm );
		if ( +validate === 1 && value !== '') {
			e.preventDefault();
			saveDataLocalStorage ('email', value );
			updatePageOrders();
		}
	});
	
	let boxs = $('.js-box');
	
	let updateBoxPage = ( ) => {
		
		addClassElem(boxs, 'dn');
		if ( userEmail === null ) {
			removeClassElem ( boxs.eq(0), 'dn' )
		} 
		else if ( userEmail !== null ) {
			removeClassElem ( boxs.eq(1), 'dn' )
		}
	}
	
	let popupLoader = $('.popup-loader'),
	popupLoaderTitle = $('.popup-loader-title');

	let showPopupLoader = () => {
		popupLoader.fadeIn(400).css('display', 'flex');
	}

	let hidePopupLoader = () => {
		popupLoader.fadeOut(400);
	}
	
	let refEmailUser = $('.email-user');
	
	let updateTitleEmail = () => {
		if (userEmail !== null) refEmailUser.text(userEmail);
	}
	
	let analysisResponseFromServer = ( data ) => {
		console.log(data);
		if (data.carts.length === 0) {
			addClassElem(boxs, 'dn');
			removeClassElem ( boxs.eq(2), 'dn' );
		} else {
			//console.log(itemsTest.data.carts);
			createMarkup(data.carts)
			//createMarkup(itemsTest.data.carts)
		}
	}
	
	let ordersInner = $('.orders__inner');
	
	let createMarkup = ( data ) => {
		let arrayHTML = data.map( elem => {
			let item = '';
			if ( +elem.status === 10 ) {
				item = $(`<div class="order-item orders__item order-item--wait">
                            <div class="order-item__text-block">
                                <div class="order-item__title">
                                    Заказ № ${elem.id} <br>
                                    <span class="order-item__title-date">
										${elem.created_at}
									</span>
                                    <span class="order-item__title-status">
										${elem.status_label}
									</span>
                                </div>
                                <div class="order-item__button-block">
                                    <button class="button button--blue order-item__payment"
									data-id="${elem.id}">
                                        оплатить
                                    </button>
                                    <button class="button order-item__delete"
									data-id="${elem.id}">
                                        удалить
                                    </button>
                                </div>
                            </div>
                            <div class="order-item__info">
                                <div class="order-item__info-title">
                                    ${elem.orders[0].cad_num} br <span class="order-item__info-title--type">
									</span>
                                </div>
                                <div class="order-item__address">
                                     ${elem.orders[0].address}
                                </div>
                                <div class="order-item__list">
                                </div>
                            </div>
                        </div>`)
				elem.orders[0].order_items.forEach( obj => {
					item.find('.order-item__list').append($(`
								<div class="order-item__list-item">
									${obj.doc_type_label}
								 </div>`));
					});	
			}
			else if ( +elem.status === 20 || +elem.status === 30 ) {
				item = $(`<div class="order-item orders__item order-item--completed">
                            <div class="order-item__text-block">
                                <div class="order-item__title">
                                    Заказ № ${elem.id} <br>
                                    <span class="order-item__title-date">
										${elem.created_at}
									</span>
                                    <span class="order-item__title-status">
										${elem.status_label}
									</span>
                                </div>
                                <div class="order-item__button-block">
                                    <button class="button order-item__download-all">
                                        скачать все выписки
                                    </button>
                                </div>
                            </div>
                            <div class="order-item__info">
                                <div class="order-item__info-title">
                                    ${elem.orders[0].cad_num} br 
									<span class="order-item__info-title--type">
									</span>
                                </div>
                                <div class="order-item__address">
                                    ${elem.orders[0].address}
                                </div>
                                <div class="order-item__list">
                                </div>
                            </div>
                        </div>`);
				elem.orders[0].order_items.forEach( obj => {
					item.find('.order-item__list').append($(`
								<div class="order-item__list-item">
									${obj.doc_type_label}
									<div class="order-item__list-item-buttons">
										<a href="${obj.result_pdf}" class="order-item__list-item-download" download>
											pdf
										 </a>
										 <a href="${obj.result_zip}" class="order-item__list-item-download" download>
											Zip
										 </a>
									  </div>
								   </div>`));
					});				
			}
			else if ( +elem.status === 40 ) {
				item = `<div class="order-item orders__item order-item--closed">
                            <div class="order-item__text-block">
                                <div class="order-item__title">
                                    Заказ № ${elem.id} <br>
                                    <span class="order-item__title-date">${elem.created_at}</span>
                                    <span class="order-item__title-status">${elem.status_label}</span>
                                </div>
                                <div class="order-item__button-block">
                                    <button class="button order-item__download-all">
                                        скачать все выписки
                                    </button>
                                </div>
                            </div>
                            <div class="order-item__info">
                                <div class="order-item__info-title">
                                    ${elem.orders[0]} br <span class="order-item__info-title--type"></span>
                                </div>
                                <div class="order-item__address">
                                    ${elem.orders[0]}
                                </div>
                            </div>
                        </div>`;
			}
			return item;
		});
		ordersInner.empty().append(...arrayHTML);
	}
	
	ordersInner.on('click', '.order-item__payment', function () {
		showPopupLoader();
		getDataAPI( urlCors + urlCancel+'?email='+userEmail+'&id='+this.dataset.id , optionsGET )
		.then( ( response ) => {
			console.log( response );
			if (response.success) {
				analysisResponseFromServer( response.data );
			} else {
				showErrorMessage ('errorUnknown', result.data.message )
			}
		})
		.catch( error => showErrorMessage ('errorUnknown'))
		.finally(() => hidePopupLoader () );
	});
	
	ordersInner.on('click', '.order-item__delete', function ( ) {
		console.log(this.dataset.id);
		optionsPOST.body = JSON.stringify({
			id: this.dataset.id,
			email: userEmail
		});
		showPopupLoader();
		getDataAPI( urlCors + urlCancel , optionsPOST )
		.then( ( response ) => {
			console.log( response );
			if (response.success) {
				console.log( response.data );
			} else {
				showErrorMessage ('errorUnknown', result.data.message )
			}
		})
		.catch( error => showErrorMessage ('errorUnknown'))
		.finally(() => hidePopupLoader () );

	});
	
	
	let ordersLogOut = $('.orders__log-out');
	
	ordersLogOut.on('click', (e)=> {
		e.preventDefault();
		saveDataLocalStorage ( 'email', []);
		updatePageOrders ();
	})
	
	
	let addClassElem = ( elem, addClassElem ) => elem.addClass(addClassElem);

	let removeClassElem = ( elem, remClassElem ) => elem.removeClass(remClassElem);
	
	
	let updatePageOrders = () => {
		getUserEmail();
		updateBoxPage ();
		getDataOrders ();
		updateTitleEmail ();
	}
	
	updatePageOrders ();

});


